services:

  # ── 1. FastAPI Application ──────────────────────────────────────────────────
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: app
    ports:
      - "${APP_PORT:-8000}:8000"
    environment:
      # Route all OTel telemetry (traces, metrics, logs) to the ADOT sidecar
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      # Set resource attributes (especially service.name) used by Loki and X-Ray
      - OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES}
    depends_on:
      - adot

  # ── 2. AWS Distro for OpenTelemetry (ADOT) ──────────────────────────────────
  adot:
    image: public.ecr.aws/aws-observability/aws-otel-collector:latest
    container_name: adot
    command: ["--config", "/etc/ecs/config.yaml"]
    volumes:
      - ./adot/config.yaml:/etc/ecs/config.yaml:ro
    ports:
      # OTLP gRPC (used by the python SDK)
      - "${ADOT_OTLP_GRPC_PORT:-4317}:4317"
      # OTLP HTTP (alternative, not currently used by app but good to have open)
      - "${ADOT_OTLP_HTTP_PORT:-4318}:4318"
      # Internal ADOT metrics (scraped by Prometheus)
      - "8888:8888"
    environment:
      - AWS_REGION=${AWS_REGION}
    depends_on:
      - prometheus
      - loki
      - xray-daemon

  # ── 3. Prometheus (Metrics Backend) ──────────────────────────────────────────
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      # Enable Remote Write receiver (ADOT pushes metrics here)
      - '--web.enable-remote-write-receiver'
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"

  # ── 4. MinIO (S3-compatible storage for Loki) ───────────────────────────────
  minio:
    image: minio/minio:latest
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data
    # Automatically create the 'loki-data' bucket on startup
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ── 5. Setup MinIO Bucket (Ephemeral helper container) ──────────────────────
  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc config host add myminio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
      /usr/bin/mc rm -r --force myminio/loki-data || true;
      /usr/bin/mc mb myminio/loki-data || true;
      /usr/bin/mc policy set public myminio/loki-data;
      exit 0;
      "

  # ── 6. Grafana Loki (Logs Backend) ──────────────────────────────────────────
  loki:
    image: grafana/loki:latest
    container_name: loki
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
    ports:
      - "${LOKI_PORT:-3100}:3100"
    depends_on:
      minio-init:
        condition: service_completed_successfully

  # ── 7. AWS X-Ray Daemon (Traces Backend) ────────────────────────────────────
  xray-daemon:
    image: amazon/aws-xray-daemon:latest
    container_name: xray-daemon
    environment:
      - AWS_REGION=${AWS_REGION}
      # Use local mode during Phase 1 (does not actually forward to AWS cloud)
      - AWS_XRAY_DAEMON_ADDRESS=0.0.0.0:2000
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
    ports:
      - "${XRAY_PORT:-2000}:2000/udp"

  # ── 8. Grafana OSS (Visualization) ──────────────────────────────────────────
  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    depends_on:
      - prometheus
      - loki
      - xray-daemon

  # ── 9. Locust (Load Generator — only runs when --profile load passed) ───────
  locust:
    build:
      context: ./locust
      dockerfile: Dockerfile
    container_name: locust
    profiles:
      - load
    environment:
      - TARGET_URL=http://app:8000
    ports:
      - "${LOCUST_PORT:-8089}:8089"
    depends_on:
      - app

volumes:
  minio-data:
